# Roadmap de Implementaci√≥n - Vista 360¬∞ del Cliente

**Basado en:** CLIENT_DATA_GAP_ANALYSIS.md
**Estado:** Pendiente de aprobaci√≥n
**Fecha:** 2 de Octubre 2025

---

## üéØ Objetivo

Transformar el sistema actual de registro b√°sico en una **plataforma de gesti√≥n inteligente** con:
- ‚úÖ Informaci√≥n completa del cliente (56+ campos)
- ‚úÖ Historial de mantenciones con m√©tricas de salud
- ‚úÖ Informaci√≥n financiera y de plan detallada
- ‚úÖ Comentarios editables en tiempo real
- ‚úÖ C√°lculo autom√°tico de KPIs de cliente

---

## üìä Estado Actual vs Objetivo

| Aspecto | Actual | Objetivo | Gap |
|---------|--------|----------|-----|
| Campos por cliente | 11 | 56+ | 82% |
| Nombre/Apellido | ‚ùå Solo completo | ‚úÖ Separado | Cr√≠tico |
| RUT | ‚ùå No | ‚úÖ S√≠ (√∫nico) | Cr√≠tico |
| Historial mantenciones | ‚ùå No | ‚úÖ 4 ciclos | Cr√≠tico |
| M√©tricas de respuesta | ‚ùå No | ‚úÖ Autom√°ticas | Cr√≠tico |
| Info financiera | ‚ùå No | ‚úÖ Completa | Alta |
| Comentarios editables | ‚ùå No | ‚úÖ S√≠ | Alta |
| TOKU integration | ‚ùå No | ‚úÖ S√≠ | Media |

---

## üöÄ Fases de Implementaci√≥n

### FASE 1: Fundaci√≥n de Datos (CR√çTICO) üî¥

**Duraci√≥n estimada:** 3-4 d√≠as

#### 1.1 Modificar Schema de Prisma

**Archivos:**
- `prisma/schema.prisma`

**Cambios en modelo `Client`:**
```prisma
// Agregar campos cr√≠ticos
firstName        String    @map("first_name")
lastName         String    @map("last_name")
rut              String?   @unique
propertyType     String?   @map("property_type")
propertyNumber   String?   @map("property_number")
generalComments  String?   @map("general_comments")  // EDITABLE
planType         String?   @map("plan_type")
planCode         String?   @map("plan_code")
planCurrency     String?   @map("plan_currency")     // UF o CLP
monthlyValueCLP  Int?      @map("monthly_value_clp")
monthlyValueUF   Decimal?  @map("monthly_value_uf") @db.Decimal(10,4)
discountPercent  Decimal?  @map("discount_percent") @db.Decimal(5,2)
tokuEnabled      Boolean   @default(false) @map("toku_enabled")
uniqueId         String?   @unique @map("unique_id") // ID Unico Excel
```

**Cambios en modelo `Maintenance`:**
```prisma
// Agregar campos de m√©tricas
cycleNumber      Int       @map("cycle_number")      // 1, 2, 3, 4
scheduledDate    DateTime  @map("scheduled_date")    // De Excel
actualDate       DateTime? @map("actual_date")       // Real
deviationDays    Int?      @map("deviation_days")    // Calculado
responseRate     String?   @map("response_rate")     // GOOD/FAIR/POOR
observations     String?                              // Campo Excel
```

#### 1.2 Crear Migraci√≥n

```bash
npx prisma migrate dev --name add_extended_client_fields
```

#### 1.3 Script de Importaci√≥n Mejorado

**Archivo:** `scripts/import-extended-client-data.ts`

**Debe:**
1. Leer Excel columna por columna (56 columnas)
2. Separar Nombre (col B) y Apellido (col C)
3. Normalizar "PResencial" ‚Üí "Presencial", "DElivery" ‚Üí "Delivery"
4. Importar 4 fechas de mantenci√≥n por cliente
5. Convertir fechas Excel (45444) a JavaScript Date
6. Validar formato de RUT chileno
7. Crear registros de Maintenance con `scheduledDate` poblado
8. Calcular `deviationDays` si hay `actualDate`
9. Manejar valores nulos correctamente

**Validaciones cr√≠ticas:**
```typescript
// Normalizar Delivery Type
const normalizeDeliveryType = (value: string): string => {
  if (!value) return 'Presencial'
  const lower = value.toLowerCase()
  if (lower.includes('presencial')) return 'Presencial'
  if (lower.includes('delivery')) return 'Delivery'
  return 'Presencial'
}

// Validar RUT chileno
const validateRUT = (rut: string): boolean => {
  const cleaned = rut.replace(/[^0-9kK]/g, '')
  if (cleaned.length < 8) return false
  // ... algoritmo de validaci√≥n
  return true
}

// Convertir fecha Excel
const excelDateToJS = (excelDate: number): Date => {
  return new Date((excelDate - 25569) * 86400 * 1000)
}

// Calcular desviaci√≥n
const calculateDeviation = (
  scheduled: Date,
  actual: Date | null
): number | null => {
  if (!actual) return null
  const diff = actual.getTime() - scheduled.getTime()
  return Math.floor(diff / (1000 * 60 * 60 * 24)) // d√≠as
}

// Calcular Response Rate
const calculateResponseRate = (deviationDays: number | null): string => {
  if (deviationDays === null) return 'PENDING'
  if (deviationDays <= 7) return 'EXCELLENT'
  if (deviationDays <= 14) return 'GOOD'
  if (deviationDays <= 30) return 'FAIR'
  return 'POOR'
}
```

#### 1.4 Actualizar API Endpoints

**Archivo:** `app/api/clients/[id]/route.ts`

Debe retornar todos los nuevos campos + m√©tricas calculadas:

```typescript
{
  client: {
    id: "uuid",
    firstName: "Felipe",
    lastName: "Caballero",
    fullName: "Felipe Caballero",
    rut: "17.704.037-1",
    // ... todos los campos
  },
  stats: {
    maintenance: {
      total: 4,
      completed: 2,
      pending: 2,
      complianceRate: 50,
      avgDeviationDays: 5,
      responseRate: "GOOD",
      nextMaintenance: { /* ... */ }
    }
  },
  healthScore: {
    overall: 85,  // 0-100
    factors: {
      maintenanceCompliance: 90,
      punctuality: 85,
      communication: 80
    }
  }
}
```

---

### FASE 2: UI de Vista 360¬∞ Mejorada üü°

**Duraci√≥n estimada:** 2-3 d√≠as

#### 2.1 Componentes Nuevos

**Archivo:** `components/clients/ClientDetailsCard.tsx`

```tsx
// Muestra informaci√≥n personal completa
<ClientDetailsCard>
  <Section title="Informaci√≥n Personal">
    <Field label="Nombre completo">{firstName} {lastName}</Field>
    <Field label="RUT">{rut}</Field>
    <Field label="Email">{email}</Field>
    <Field label="Tel√©fono">{phone}</Field>
  </Section>

  <Section title="Direcci√≥n">
    <Field label="Calle">{address}</Field>
    <Field label="Tipo">{propertyType}</Field>
    <Field label="N√∫mero">{propertyNumber}</Field>
    <Field label="Comuna">{comuna}</Field>
  </Section>
</ClientDetailsCard>
```

**Archivo:** `components/clients/PlanInformationCard.tsx`

```tsx
// Muestra plan financiero completo
<PlanInformationCard>
  <PlanBadge type={planType} code={planCode} />

  <PricingDisplay>
    <Currency>{planCurrency}</Currency>
    {planCurrency === 'CLP' ? (
      <Price>{formatCLP(monthlyValueCLP)}</Price>
    ) : (
      <Price>{monthlyValueUF} UF</Price>
    )}
    {discountPercent > 0 && (
      <Discount>{discountPercent}% descuento</Discount>
    )}
  </PricingDisplay>

  <PaymentMethods>
    {tokuEnabled && <Badge color="blue">TOKU</Badge>}
    {transferEnabled && <Badge color="green">Transferencia</Badge>}
  </PaymentMethods>
</PlanInformationCard>
```

**Archivo:** `components/clients/MaintenanceHistoryCard.tsx`

```tsx
// Muestra historial de mantenciones con m√©tricas
<MaintenanceHistoryCard>
  <HealthMetrics>
    <Metric label="Compliance" value="75%" color="green" />
    <Metric label="Desviaci√≥n Promedio" value="5 d√≠as" color="yellow" />
    <Metric label="Response Rate" value="GOOD" color="green" />
  </HealthMetrics>

  <MaintenanceTimeline>
    {maintenances.map(m => (
      <MaintenanceItem
        key={m.id}
        cycle={m.cycleNumber}
        scheduled={m.scheduledDate}
        actual={m.actualDate}
        deviation={m.deviationDays}
        status={m.status}
        responseRate={m.responseRate}
      />
    ))}
  </MaintenanceTimeline>
</MaintenanceHistoryCard>
```

**Archivo:** `components/clients/EditableCommentsCard.tsx`

```tsx
// Campo de comentarios editables en tiempo real
<EditableCommentsCard>
  <CommentHeader>
    <Title>Comentarios Generales</Title>
    <EditButton onClick={toggleEdit} />
  </CommentHeader>

  {isEditing ? (
    <TextArea
      value={comments}
      onChange={setComments}
      onSave={handleSave}
      onCancel={handleCancel}
      placeholder="Agregar notas sobre el cliente..."
    />
  ) : (
    <CommentDisplay>{comments || 'Sin comentarios'}</CommentDisplay>
  )}

  <LastEdited>√öltima edici√≥n: {lastEditedDate}</LastEdited>
</EditableCommentsCard>
```

#### 2.2 Layout de P√°gina del Cliente

**Archivo:** `app/clients/[id]/page.tsx`

```tsx
<ClientDetailPage>
  <Header>
    <ClientAvatar />
    <ClientTitle firstName={firstName} lastName={lastName} />
    <HealthScoreBadge score={healthScore} />
  </Header>

  <Grid columns={3}>
    {/* Columna 1: Info Personal */}
    <Column>
      <ClientDetailsCard />
      <EquipmentDetailsCard />
    </Column>

    {/* Columna 2: Plan y Finanzas */}
    <Column>
      <PlanInformationCard />
      <PaymentHistoryCard />
    </Column>

    {/* Columna 3: Mantenciones y Salud */}
    <Column>
      <MaintenanceHistoryCard />
      <HealthMetricsCard />
    </Column>
  </Grid>

  {/* Fila completa: Comentarios editables */}
  <FullWidthRow>
    <EditableCommentsCard />
  </FullWidthRow>

  {/* Fila completa: Timeline de eventos */}
  <FullWidthRow>
    <ActivityTimeline events={allEvents} />
  </FullWidthRow>
</ClientDetailPage>
```

---

### FASE 3: Analytics y Dashboards üü¢

**Duraci√≥n estimada:** 2 d√≠as

#### 3.1 Dashboard de Salud de Clientes

**Archivo:** `app/dashboard/client-health/page.tsx`

```tsx
// Dashboard agregado de m√©tricas de todos los clientes
<ClientHealthDashboard>
  <KPICards>
    <KPI
      title="Compliance Promedio"
      value="78%"
      trend="+5%"
      color="green"
    />
    <KPI
      title="Desviaci√≥n Promedio"
      value="8.5 d√≠as"
      trend="-2 d√≠as"
      color="yellow"
    />
    <KPI
      title="Clientes EXCELLENT"
      value="245"
      percentage="38%"
      color="blue"
    />
    <KPI
      title="Clientes POOR"
      value="87"
      percentage="14%"
      color="red"
    />
  </KPICards>

  <Charts>
    <LineChart
      title="Evoluci√≥n de Compliance"
      data={complianceOverTime}
    />
    <PieChart
      title="Distribuci√≥n por Response Rate"
      data={responseRateDistribution}
    />
    <BarChart
      title="Desviaci√≥n por Comuna"
      data={deviationByComuna}
    />
  </Charts>

  <Tables>
    <ClientTable
      title="Clientes con Mayor Riesgo"
      filter={{ responseRate: 'POOR' }}
      limit={10}
    />
    <ClientTable
      title="Clientes M√°s Saludables"
      filter={{ responseRate: 'EXCELLENT' }}
      limit={10}
    />
  </Tables>
</ClientHealthDashboard>
```

#### 3.2 Reportes Automatizados

**Archivo:** `lib/reports/client-health-report.ts`

```typescript
// Generar reportes autom√°ticos semanales/mensuales
export async function generateClientHealthReport(
  period: 'weekly' | 'monthly'
): Promise<Report> {
  const clients = await prisma.client.findMany({
    include: { maintenances: true }
  })

  return {
    period,
    generatedAt: new Date(),
    summary: {
      totalClients: clients.length,
      avgHealthScore: calculateAvgHealthScore(clients),
      topPerformers: getTopPerformers(clients, 10),
      atRiskClients: getAtRiskClients(clients, 10),
      complianceTrend: calculateComplianceTrend(clients),
    },
    insights: generateInsights(clients),
    recommendations: generateRecommendations(clients)
  }
}
```

---

## üîß Tareas T√©cnicas Detalladas

### Task 1: Actualizar Schema
- [ ] Modificar `prisma/schema.prisma`
- [ ] Agregar 35+ campos nuevos a modelo `Client`
- [ ] Agregar campos de m√©tricas a modelo `Maintenance`
- [ ] Ejecutar `npx prisma migrate dev`
- [ ] Verificar migraci√≥n en Supabase

### Task 2: Script de Importaci√≥n
- [ ] Crear `scripts/import-extended-client-data.ts`
- [ ] Implementar lectura de 56 columnas de Excel
- [ ] Implementar normalizaci√≥n de datos
- [ ] Implementar validaciones (RUT, fechas, etc.)
- [ ] Importar 4 fechas de mantenci√≥n por cliente
- [ ] Calcular m√©tricas autom√°ticas
- [ ] Ejecutar importaci√≥n y verificar

### Task 3: Actualizar APIs
- [ ] Modificar `app/api/clients/[id]/route.ts`
- [ ] Agregar campos nuevos a respuesta
- [ ] Calcular m√©tricas en tiempo real
- [ ] Crear endpoint para actualizar comentarios
- [ ] Crear endpoint para m√©tricas agregadas

### Task 4: Componentes UI
- [ ] Crear `ClientDetailsCard.tsx`
- [ ] Crear `PlanInformationCard.tsx`
- [ ] Crear `MaintenanceHistoryCard.tsx`
- [ ] Crear `EditableCommentsCard.tsx`
- [ ] Crear `HealthMetricsCard.tsx`
- [ ] Actualizar `app/clients/[id]/page.tsx`

### Task 5: Testing
- [ ] Probar importaci√≥n de datos
- [ ] Verificar c√°lculo de m√©tricas
- [ ] Probar edici√≥n de comentarios
- [ ] Verificar visualizaci√≥n de mantenciones
- [ ] Probar en producci√≥n

---

## üì¶ Entregables por Fase

### Fase 1 Completada:
- ‚úÖ Schema actualizado con 35+ campos
- ‚úÖ Script de importaci√≥n funcionando
- ‚úÖ 641 clientes con datos completos
- ‚úÖ Historial de 2564 mantenciones (4 por cliente)
- ‚úÖ APIs retornando datos extendidos

### Fase 2 Completada:
- ‚úÖ Vista 360¬∞ del cliente completamente funcional
- ‚úÖ Comentarios editables en tiempo real
- ‚úÖ M√©tricas de salud visibles
- ‚úÖ Timeline de mantenciones con desviaciones

### Fase 3 Completada:
- ‚úÖ Dashboard de salud agregado
- ‚úÖ Reportes automatizados
- ‚úÖ Insights y recomendaciones
- ‚úÖ Exportaci√≥n de datos

---

## üéØ M√©tricas de √âxito

Al completar todas las fases, el sistema debe:

1. **Datos Completos**
   - ‚úÖ 56+ campos por cliente
   - ‚úÖ 100% de clientes con historial de mantenciones
   - ‚úÖ M√©tricas calculadas autom√°ticamente

2. **Funcionalidad**
   - ‚úÖ Edici√≥n de comentarios en < 2 segundos
   - ‚úÖ C√°lculo de health score en < 500ms
   - ‚úÖ Visualizaci√≥n completa en < 1 segundo

3. **Insights Accionables**
   - ‚úÖ Identificar clientes en riesgo
   - ‚úÖ Medir compliance por comuna/plan
   - ‚úÖ Predecir cancelaciones
   - ‚úÖ Optimizar rutas de t√©cnicos

4. **Experiencia de Usuario**
   - ‚úÖ Interface intuitiva y r√°pida
   - ‚úÖ Informaci√≥n f√°cil de encontrar
   - ‚úÖ Acciones claras y simples
   - ‚úÖ Responsive en mobile/desktop

---

## ‚ö†Ô∏è Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|--------------|---------|------------|
| Datos inconsistentes en Excel | Media | Alto | Validaciones estrictas + logs detallados |
| Performance con 2500+ mantenciones | Media | Medio | Indexes en DB + paginaci√≥n |
| C√°lculos incorrectos de m√©tricas | Baja | Alto | Tests unitarios + validaci√≥n manual |
| Migraci√≥n falla en producci√≥n | Baja | Cr√≠tico | Backup completo + rollback plan |

---

## üìÖ Timeline Estimado

```
Semana 1: Fase 1 (Fundaci√≥n de Datos)
‚îú‚îÄ D√≠a 1-2: Schema + Migraci√≥n
‚îú‚îÄ D√≠a 3-4: Script de importaci√≥n
‚îî‚îÄ D√≠a 5: Testing y validaci√≥n

Semana 2: Fase 2 (UI Vista 360¬∞)
‚îú‚îÄ D√≠a 1-2: Componentes base
‚îú‚îÄ D√≠a 3: Integraci√≥n p√°gina cliente
‚îî‚îÄ D√≠a 4-5: Testing + refinamiento

Semana 3: Fase 3 (Analytics)
‚îú‚îÄ D√≠a 1-2: Dashboard salud clientes
‚îú‚îÄ D√≠a 3: Reportes automatizados
‚îî‚îÄ D√≠a 4-5: Testing final + deployment
```

**Total: ~15 d√≠as h√°biles (3 semanas)**

---

## ‚úÖ Aprobaci√≥n y Siguiente Paso

**Para proceder con la implementaci√≥n, necesitamos:**

1. ‚úÖ Aprobaci√≥n del cliente sobre campos a incluir
2. ‚úÖ Confirmaci√≥n de prioridades (¬øTodas las fases o solo Fase 1?)
3. ‚úÖ Validaci√≥n del formato de datos de Excel
4. ‚úÖ Plan de backup antes de migraci√≥n en producci√≥n

**Pregunta clave para el cliente:**
> ¬øDeseas implementar todas las fases (3 semanas) o comenzar solo con Fase 1 (datos cr√≠ticos, 1 semana) y luego evaluar?

---

*Documento listo para revisi√≥n con el equipo y cliente.*
